<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>감옥 탈출</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: 'Malgun Gothic', sans-serif;
    }
    .scene {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        position: relative;
        display: none;
    }
    #scene1 {
        background-image: url('https://i.ibb.co/fYRTS5kj/Whisk-storyboardfff99d811e714b7b82527f8b-2.jpg');
    }
    #scene2 {
        background-image: url('https://i.ibb.co/dsgpmqhj/Whisk-469b110f7e.jpg');
    }
    #scene3 {
        background-image: url('https://i.ibb.co/ZpRPRK9V/Whisk-1cc4ab5545.jpg');
    }
    .clickable {
        position: absolute;
        cursor: pointer;
        /* MODIFIED: Yellow border removed */
        background-color: rgba(255, 255, 0, 0);
    }
    /* Scene 1 Clickable Areas */
    #blue-shirt { top: 30%; left: 83%; width: 10%; height: 25%; }
    #bookshelf { top: 55%; left: 45%; width: 15%; height: 30%; }
    #window { top: 10%; left: 10%; width: 30%; height: 50%; }
    #blanket { top: 70%; left: 65%; width: 30%; height: 25%; }

    /* Scene 2 Clickable Areas */
    #tree { top: 30%; left: 45%; width: 15%; height: 50%; }
    #searchlight { top: 30%; left: 75%; width: 20%; height: 20%; }
    #right-wall { top: 25%; left: 85%; width: 15%; height: 50%; }

    /* Scene 3 Clickable Areas */
    #wall { top: 20%; left: 75%; width: 25%; height: 50%; }
    #gate { top: 30%; left: 25%; width: 50%; height: 60%; }
    #exit-sign { top: 20%; left: 40%; width: 20%; height: 10%; }

    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 300px;
        text-align: center;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    /* === MINIGAME STYLES START === */
    #circle-game-wrapper {
        display: none;
        position: fixed;
        z-index: 50;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    #circle-game-container {
        width: 600px;
        height: 400px;
        border: 3px solid #333;
        position: relative;
        background-color: #000000;
        overflow: hidden;
    }
    #cg-player { position: absolute; width: 40px; height: 40px; background-color: #007bff; }
    #cg-enemy { position: absolute; width: 100px; height: 100px; background-color: #ffc107; border-radius: 50%; }
    #cg-info { margin-top: 15px; font-size: 1.2em; color: #fff; }
    .cg-wall { position: absolute; background-color: #34495e; }

    #parkour-game-container {
        display: none;
        position: fixed;
        z-index: 50;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #2c3e50;
        overflow: hidden;
    }
    #parkour-player { position: absolute; width: 30px; height: 30px; background-color: #2ecc71; }
    .platform { position: absolute; height: 20px; background-color: #95a5a6; }
    #parkour-goal { position: absolute; width: 50px; height: 50px; background: gold; box-shadow: 0 0 20px gold; border-radius: 5px; }
    .spike { position: absolute; width: 20px; height: 20px; background-color: #e74c3c; }
    /* === MINIGAME STYLES END === */
    
    /* === INTRO/ENDING SCREEN STYLES === */
    .overlay-screen {
        display: flex;
        position: fixed;
        z-index: 200;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        justify-content: center;
        align-items: center;
        text-align: center;
        color: white;
    }
    .overlay-content {
        padding: 40px;
        max-width: 600px;
        animation: fadeIn 1s ease-in-out;
    }
    .overlay-content h2 {
        font-size: 2.8em;
        margin-bottom: 20px;
        color: #f1c40f;
    }
    .overlay-content p {
        font-size: 1.2em;
        line-height: 1.7;
        margin-bottom: 40px;
    }
    .overlay-content button {
        padding: 15px 30px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid white;
        background-color: transparent;
        color: white;
        transition: all 0.3s ease;
    }
    .overlay-content button:hover {
        background-color: white;
        color: black;
    }
    #ending-screen {
        display: none; /* Hidden by default */
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
</head>
<body>

<!-- Story/Ending Screens -->
<div id="introduction-screen" class="overlay-screen">
    <div class="overlay-content">
        <h2>탈출의 시작</h2>
        <!-- MODIFIED: Instructions added -->
        <p>
            나는 억울하게 감옥에 갇혔다.<br>
            하지만 절망 속 한 줄기 빛...<br>
            내가 들어온 이 방은 전설적인 탈옥 고수가 머물던 곳이라고 한다.<br>
            그가 남긴 흔적을 찾아 반드시 탈출해야 한다!
            <br><br>
            <strong>[조작법]</strong><br>
            - 상호작용: 마우스 클릭<br>
            - 미니게임: W, A, S, D
            <br><br>
            <i>(튜토리얼: 게임이 시작되면, 먼저 책장을 클릭해보세요.)</i>
        </p>
        <button id="start-button">게임 시작</button>
    </div>
</div>

<div id="ending-screen" class="overlay-screen">
    <div class="overlay-content">
        <h2>탈출 성공!</h2>
        <p>마침내 당신은 모든 암호를 풀고 감옥 문을 열었습니다.<br>자유를 만끽하세요!</p>
        <button id="restart-button">다시 플레이</button>
    </div>
</div>

<!-- Main Game Scenes -->
<div id="scene1" class="scene" style="display: none;">
    <div id="blue-shirt" class="clickable" onclick="showAlert('옷 안에 옛날에 탈옥했던 사람의 쪽지가 있다. 쪽지에 [내 생일은-월-일]이라 적혀 있다.')"></div>
    <div id="bookshelf" class="clickable" onclick="showAlert('책장에는 오래된 책들이 꽂혀있다. 그 중 한 책에 [나무가 6월 3일에 심어졌다]이라고 적혀있다. 잘 기억해 두는 게 좋겠다.')"></div>
    <div id="window" class="clickable" onclick="showPasswordModal(1, '0115')"></div>
    <div id="blanket" class="clickable" onclick="showAlert('이불을 들춰보니 1월 15일에[오늘은 나의 생일]이라고 적힌 달력이 있다.')"></div>
</div>

<div id="scene2" class="scene">
    <div id="tree" class="clickable" onclick="showAlert('나무에 작게 뭐가 새겨져 있다. 어두워서 잘 보이지 않는다.')"></div>
    <div id="searchlight" class="clickable" onclick="startCircleGame()"></div>
    <div id="right-wall" class="clickable" onclick="showPasswordModal(2, '0603')"></div>
</div>

<div id="scene3" class="scene">
    <div id="wall" class="clickable" onclick="startParkourGame()"></div>
    <div id="gate" class="clickable" onclick="showPasswordModal(3, '9636')"></div>
    <div id="exit-sign" class="clickable" onclick="showAlert('작게 글씨가 써져 있다.[2=4]')"></div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">×</span>
        <p>비밀번호를 입력하세요:</p>
        <input type="text" id="passwordInput">
        <button onclick="checkPassword()">확인</button>
    </div>
</div>

<!-- Minigame Containers -->
<div id="circle-game-wrapper">
    <div id="circle-game-container">
        <div id="cg-player"></div>
        <div id="cg-enemy"></div>
        <div class="cg-wall" style="left: 100px; top: 100px; width: 20px; height: 200px;"></div>
        <div class="cg-wall" style="right: 100px; top: 100px; width: 20px; height: 200px;"></div>
        <div class="cg-wall" style="left: 200px; top: 180px; width: 200px; height: 20px;"></div>
    </div>
    <div id="cg-info">생존 시간: <span id="cg-timer">0</span>초</div>
</div>

<div id="parkour-game-container">
    <div id="parkour-player"></div>
    <div class="platform" style="bottom: 50px; left: 0px; width: 150px;"></div>
    <div class="platform" style="bottom: 130px; left: 200px; width: 100px;"></div>
    <div class="platform" style="bottom: 130px; left: 380px; width: 100px;"></div>
    <div class="spike" style="bottom: 150px; left: 420px;"></div>
    <div class="platform moving-h" data-range-start="520" data-range-end="650" data-speed="2" style="bottom: 220px; left: 520px; width: 100px;"></div>
    <div class="platform" style="bottom: 220px; left: 750px; width: 100px;"></div>
    <div id="parkour-goal" style="bottom: 300px; left: 880px;"></div>
</div>


<script>
    let currentScene = 1;
    let correctPassword = '';
    let stageToUnlock = 0;

    const introductionScreen = document.getElementById('introduction-screen');
    const endingScreen = document.getElementById('ending-screen');
    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');

    startButton.addEventListener('click', () => {
        introductionScreen.style.display = 'none';
        document.getElementById('scene1').style.display = 'block';
    });

    restartButton.addEventListener('click', () => {
        location.reload();
    });

    function showAlert(message) {
        alert(message);
    }

    function showPasswordModal(stage, password) {
        stageToUnlock = stage;
        correctPassword = password;
        document.getElementById('passwordModal').style.display = 'block';
        document.getElementById('passwordInput').focus();
    }

    function closeModal() {
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('passwordInput').value = '';
    }

    function checkPassword() {
        const input = document.getElementById('passwordInput').value;
        if (input === correctPassword) {
            alert('정답입니다!');
            closeModal();
            changeScene(stageToUnlock + 1);
        } else {
            alert('틀렸습니다.');
        }
    }

    function changeScene(sceneNumber) {
        if (currentScene > 0 && document.getElementById('scene' + currentScene)) {
           document.getElementById('scene' + currentScene).style.display = 'none';
        }
        
        if (sceneNumber > 3) {
            endingScreen.style.display = 'flex';
            return;
        }

        document.getElementById('scene' + sceneNumber).style.display = 'block';
        currentScene = sceneNumber;
    }

    // ========================================================
    // Minigame 1: Yellow Circle Dodge
    // ========================================================
    function startCircleGame() {
        alert("서치라이트가 나를 발견했다! 벽을 이용해 12초 동안 피해야 한다!");
        const gameWrapper = document.getElementById('circle-game-wrapper');
        const gameContainer = document.getElementById('circle-game-container');
        const player = document.getElementById('cg-player');
        const enemy = document.getElementById('cg-enemy');
        const timerDisplay = document.getElementById('cg-timer');
        const walls = gameContainer.querySelectorAll('.cg-wall');
        
        let playerX, playerY;
        let enemyX, enemyY;
        let enemySpeedX, enemySpeedY;
        let gameInterval;
        let timerInterval;
        let keys = {};
        const playerSpeed = 7;
        
        gameWrapper.style.display = 'flex';
        playerX = gameContainer.offsetWidth / 2 - player.offsetWidth / 2;
        playerY = gameContainer.offsetHeight - player.offsetHeight - 5;
        
        const safeZoneRadius = 150;
        do {
            enemyX = Math.random() * (gameContainer.offsetWidth - enemy.offsetWidth);
            enemyY = Math.random() * (gameContainer.offsetHeight - enemy.offsetHeight);
        } while (Math.sqrt(Math.pow(enemyX - playerX, 2) + Math.pow(enemyY - playerY, 2)) < safeZoneRadius);

        enemySpeedX = (Math.random() > 0.5 ? 1 : -1) * 6;
        enemySpeedY = (Math.random() > 0.5 ? 1 : -1) * 6;
        let secondsSurvived = 0;
        timerDisplay.textContent = 0;

        const onKeyDown = (e) => { keys[e.key.toLowerCase()] = true; };
        const onKeyUp = (e) => { keys[e.key.toLowerCase()] = false; };
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);

        const endGame = (isWin) => {
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            window.removeEventListener('keydown', onKeyDown);
            window.removeEventListener('keyup', onKeyUp);
            gameWrapper.style.display = 'none';
            if (isWin) {
                alert("무사히 피했다! 내가 나무에 숨으니 서치라이트가 나를 놓쳤다. 나무에 빛이 비치니 심은 날이라 적혀 있다.");
            } else {
                alert("붙잡혔다! 다시 시도해 보자.");
            }
        };

        timerInterval = setInterval(() => {
            secondsSurvived++;
            timerDisplay.textContent = secondsSurvived;
            if (secondsSurvived >= 12) endGame(true);
        }, 1000);

        gameInterval = setInterval(() => {
            let nextPlayerX = playerX, nextPlayerY = playerY;

            if (keys['w']) nextPlayerY -= playerSpeed;
            if (keys['s']) nextPlayerY += playerSpeed;
            if (keys['a']) nextPlayerX -= playerSpeed;
            if (keys['d']) nextPlayerX += playerSpeed;

            if (nextPlayerX < 0) nextPlayerX = 0;
            if (nextPlayerX > gameContainer.offsetWidth - 40) nextPlayerX = gameContainer.offsetWidth - 40;
            if (nextPlayerY < 0) nextPlayerY = 0;
            if (nextPlayerY > gameContainer.offsetHeight - 40) nextPlayerY = gameContainer.offsetHeight - 40;

            let collisionX = false, collisionY = false;
            walls.forEach(wall => {
                if (nextPlayerX < wall.offsetLeft + wall.offsetWidth && nextPlayerX + 40 > wall.offsetLeft &&
                    playerY < wall.offsetTop + wall.offsetHeight && playerY + 40 > wall.offsetTop) {
                    collisionX = true;
                }
                if (playerX < wall.offsetLeft + wall.offsetWidth && playerX + 40 > wall.offsetLeft &&
                    nextPlayerY < wall.offsetTop + wall.offsetHeight && nextPlayerY + 40 > wall.offsetTop) {
                    collisionY = true;
                }
            });

            if (!collisionX) playerX = nextPlayerX;
            if (!collisionY) playerY = nextPlayerY;
            
            if (enemyX + enemySpeedX < 0 || enemyX + enemySpeedX > gameContainer.offsetWidth - 100) enemySpeedX *= -1;
            if (enemyY + enemySpeedY < 0 || enemyY + enemySpeedY > gameContainer.offsetHeight - 100) enemySpeedY *= -1;
            
            enemyX += enemySpeedX;
            enemyY += enemySpeedY;
            
            player.style.left = playerX + 'px';
            player.style.top = playerY + 'px';
            enemy.style.left = enemyX + 'px';
            enemy.style.top = enemyY + 'px';

            if (playerX < enemyX + 100 && playerX + 40 > enemyX && playerY < enemyY + 100 && playerY + 40 > enemyY) {
                endGame(false);
            }
        }, 20);
    }

    // ========================================================
    // Minigame 2: Parkour
    // ========================================================
    function startParkourGame() {
        alert("저기 비밀번호가 적힌 금색 쪽지가 있다! 가시와 움직이는 발판을 피해 도착하면 비밀번호를 볼 수 있다! (점프: W)");
        const gameContainer = document.getElementById('parkour-game-container');
        gameContainer.style.display = 'block';

        const player = document.getElementById('parkour-player');
        const goal = document.getElementById('parkour-goal');
        const allPlatforms = document.querySelectorAll('.platform');
        const spikes = document.querySelectorAll('.spike');
        
        const startX = 50, startY = 100;
        let playerX = startX, playerY = startY;
        let velocityX = 0, velocityY = 0;
        let onGround = false;
        
        const moveSpeed = 4, jumpPower = 11, gravity = 0.5;
        let keys = {}, gameLoopId = null;

        const movingPlatforms = [];
        document.querySelectorAll('.moving-h, .moving-v').forEach(p => {
            const isVertical = p.classList.contains('moving-v');
            movingPlatforms.push({
                el: p, isVertical: isVertical, speed: parseFloat(p.dataset.speed), dir: 1,
                range: [parseInt(p.dataset.rangeStart), parseInt(p.dataset.rangeEnd)],
                currentPos: parseFloat(isVertical ? p.style.bottom : p.style.left)
            });
        });

        const resetPlayer = () => { playerX = startX; playerY = startY; velocityY = 0; velocityX = 0; };
        const onKeyDown = (e) => { keys[e.key.toLowerCase()] = true; };
        const onKeyUp = (e) => { keys[e.key.toLowerCase()] = false; };
        
        const cleanupAndExit = (message) => {
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoopId = null;
            document.removeEventListener('keydown', onKeyDown);
            document.removeEventListener('keyup', onKeyUp);
            gameContainer.style.display = 'none';
            alert(message);
        };
        
        resetPlayer();
        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        function parkourLoop() {
            movingPlatforms.forEach(mp => {
                mp.currentPos += mp.speed * mp.dir;
                if (mp.currentPos > mp.range[1] || mp.currentPos < mp.range[0]) mp.dir *= -1;
                if (mp.isVertical) mp.el.style.bottom = mp.currentPos + 'px';
                else mp.el.style.left = mp.currentPos + 'px';
            });

            velocityX = 0;
            if (keys['a']) velocityX = -moveSpeed;
            if (keys['d']) velocityX = moveSpeed;
            if (keys['w'] && onGround) { velocityY = jumpPower; onGround = false; }

            velocityY -= gravity;
            let playerY_prev = playerY;
            playerX += velocityX;
            playerY += velocityY;
            onGround = false;

            allPlatforms.forEach(platform => {
                const pLeft = platform.offsetLeft, pRight = pLeft + platform.offsetWidth;
                const pBottom = parseFloat(platform.style.bottom), pTop = pBottom + platform.offsetHeight;
                
                if (playerY_prev >= pTop && playerY <= pTop && playerX + 30 > pLeft && playerX < pRight) {
                    onGround = true; velocityY = 0; playerY = pTop;
                    const movingData = movingPlatforms.find(mp => mp.el === platform);
                    if (movingData && !movingData.isVertical) playerX += movingData.speed * movingData.dir;
                }
            });
            
            if (playerY < 0) { resetPlayer(); gameLoopId = requestAnimationFrame(parkourLoop); return; }

            spikes.forEach(spike => {
                if (playerX < spike.offsetLeft + 20 && playerX + 30 > spike.offsetLeft &&
                    playerY < parseFloat(spike.style.bottom) + 20 && playerY + 30 > parseFloat(spike.style.bottom)) {
                    alert('가시에 찔렸다! 처음으로 돌아갑니다.');
                    resetPlayer(); gameLoopId = requestAnimationFrame(parkourLoop); return;
                }
            });

            if (playerX < goal.offsetLeft + 50 && playerX + 30 > goal.offsetLeft &&
                playerY < parseFloat(goal.style.bottom) + 50 && playerY + 30 > parseFloat(goal.style.bottom)) {
                cleanupAndExit('성공! 쪽지에는 [963*] 이라고 적혀있다.'); return;
            }
            
            player.style.left = playerX + 'px';
            player.style.bottom = playerY + 'px';
            gameLoopId = requestAnimationFrame(parkourLoop);
        }
        gameLoopId = requestAnimationFrame(parkourLoop);
    }
</script>

</body>
</html>
